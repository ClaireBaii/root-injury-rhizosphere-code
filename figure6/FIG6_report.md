# Figure 6 分析报告

## 1. 文件清单

| 类型 | 文件名 |
|------|--------|
| 主脚本 | `Fig6_phylum_trajectory_with_stats.R` |
| 任务清单 | `ToDO_fig6.md` |
| 数据输入 | `data/完整数据-微生物.csv` (相对于项目根目录) |
| 统计输出 | `Fig6_phylum_stats.csv` |
| 图形输出 | `Fig6_main.pdf`, `Fig6_main.tiff` |
| 旧版脚本 | `figure6 趋势菌门筛选 + 清洗列名 + 匹配绘图.R` (未使用) |

---

## 2. 图形展示内容

### 整图概述

Figure 6 展示了**趋势型响应菌门的相对丰度随主根截断比例 (RS) 的变化轨迹**，回答的核心问题是：**哪些细菌门对根系截断处理表现出显著的单调趋势响应？**

### Panel 结构

图中包含 **5 个子面板**，分别对应 5 个筛选出的趋势型菌门：

| Panel | 菌门名称 | 趋势方向 |
|-------|---------|----------|
| 1 | Armatimonadota | 先升后降 (非严格单调) |
| 2 | Bdellovibrionota | 上升趋势 (增加) |
| 3 | Desulfobacterota | 上升趋势 (增加) |
| 4 | Patescibacteria | 先升后降 (非严格单调) |
| 5 | unclassified_Bacteria | 波动 |

每个面板以 **点线图 + 误差条** 形式呈现，X 轴为处理水平 (RS = 0, 25, 50, 75, 100%)，Y 轴为相对丰度 (%)。

---

## 3. 数据来源与样本结构

### 数据文件
- **输入**: `完整数据-微生物.csv`
- **内容**: OTU 丰度表 + taxonomy 列

### 样本结构
- **样本命名格式**: `RDYS_{treat_id}-{tree_id}`
  - `treat_id`: 1–5，对应 RS = 0, 25, 50, 75, 100%
  - `tree_id`: 1–3，代表 3 棵独立树木
- **每处理组样本量**: n = 3 (tree-level 独立重复)
- **总样本量**: 5 处理 × 3 树 = 15

### 汇总水平
- 图中展示的是 **treatment-level mean ± SD** (处理组平均值 ± 标准差)
- **不是**单点数据，**不是**样本级别

---

## 4. 数据预处理流程

| 步骤 | 操作 | 代码位置 |
|------|------|----------|
| 1 | 读取 OTU 表 (CSV) | L70 |
| 2 | 提取 Phylum 信息 (正则解析 `p__xxx`) | L82-88 |
| 3 | 将 OTU 计数按 Phylum 聚合 (`rowsum`) | L97 |
| 4 | 计算相对丰度 (每样本 TIC 标准化) | L99 |
| 5 | 宽表转长表 (`pivot_longer`) | L104-106 |
| 6 | 解析样本名获取处理组和树编号 | L108-123 |
| 7 | 按 Phylum × RS 计算 mean/sd | L151-158 |

### 关键参数
- **丰度标准化**: TIC (Total Ion Current)，即列和归一化
- **缺失值处理**: `NA` 保留，汇总时使用 `na.rm = TRUE`
- **无 log 变换**: 相对丰度直接使用，未做 log 转换

---

## 5. 统计/分析方法清单

### 5.1 菌门筛选

| 方法 | 参数 | 说明 |
|------|------|------|
| Spearman 相关 | ρ vs RS (以组均值计算) | 评估丰度与处理水平的单调关系 |
| 筛选阈值 | \|ρ\| ≥ 0.7 | 强趋势关系 |
| 最小丰度 | overall mean ≥ 0.1% | 过滤稀有门 |
| 最大数量 | TOP_N = 10 | 最多展示 10 个门 |

### 5.2 组间差异检验

#### Kruskal-Wallis 检验
- **目的**: 检验各处理组间相对丰度是否存在显著差异
- **检验水平**: 每个菌门独立检验
- **多重校正**: BH (Benjamini-Hochberg) 法校正，**跨所有展示的菌门**
- **代码位置**: L255-258

#### Dunn 事后多重比较
- **目的**: 两两比较各处理组间差异
- **检验水平**: 每个菌门内的两两比较
- **多重校正**: BH 法校正，**在每个菌门内部**
- **代码位置**: L260-263

### 显著性标注规则
```
*** : q < 0.001
**  : q < 0.01
*   : q < 0.05
ns  : q ≥ 0.05
```

---

## 6. 可视化编码要点

| 元素 | 编码 |
|------|------|
| X 轴 | RS = 0, 25, 50, 75, 100 (%) |
| Y 轴 | 相对丰度 (%) |
| 点 | 处理组均值 |
| 误差线 | ± SD (标准差) |
| 连线 | 灰色细线连接各处理组 |
| 显著性标注 | 右上角显示 KW q 值 + 星号 |
| 面板标题 | 菌门名称 (粗体) |

### 布局
- **3 + 2 布局**: 上排 3 个面板，下排 2 个面板（居中）
- **图形尺寸**: 11 × 8 英寸

---

## 7. 使用的 R 包/函数

### 数据处理
| 包 | 函数 | 用途 |
|----|------|------|
| dplyr | `group_by`, `summarise`, `mutate`, `left_join`, `filter` | 数据整理 |
| tidyr | `pivot_longer` | 宽转长 |

### 统计分析
| 包 | 函数 | 用途 |
|----|------|------|
| stats | `kruskal.test` | Kruskal-Wallis 检验 |
| stats | `p.adjust` | BH 多重校正 |
| base | 自定义 `dunn_test()` | Dunn 事后比较 (手动实现) |

### 可视化
| 包 | 函数 | 用途 |
|----|------|------|
| ggplot2 | `ggplot`, `geom_line`, `geom_pointrange`, `geom_text` | 主图绑制 |
| patchwork | `wrap_plots` | 多面板组合 |

---

## 8. 统计结果摘要

基于 `Fig6_phylum_stats.csv`：

| 菌门 | KW p | KW q (BH) | 显著性 |
|------|------|-----------|--------|
| Armatimonadota | 0.0144 | 0.0356 | * |
| Bdellovibrionota | 0.0285 | 0.0356 | * |
| Desulfobacterota | 0.0266 | 0.0356 | * |
| Patescibacteria | 0.0273 | 0.0356 | * |
| unclassified_Bacteria | 0.0471 | 0.0471 | * |

> 所有展示的菌门在 α = 0.05 水平下均表现出显著的组间差异。

---

## 9. 潜在风险点

| 风险项 | 状态 | 说明 |
|--------|------|------|
| 组均值替代样本点 | ⚠️ 存在 | 图中展示的是 n=3 的处理组均值，非原始样本点 |
| n 标注 | ✅ 正确 | 图注说明 n=3 (trees per treatment) |
| SD vs SE | ✅ 明确 | 误差线为 SD (代码 L156-157, L338) |
| 相关系数计算 | ⚠️ 注意 | Spearman ρ 基于组均值计算 (5 点)，非原始样本 |
| 多重校正范围 | ✅ 合理 | KW 跨菌门校正，Dunn 菌门内校正 |

---

## 10. 方法学注释

1. **样本独立性**: 每棵树视为独立生物学重复，符合伪重复规避要求
2. **非参数检验选择**: 小样本 (n=3/组) + 非正态分布假设 → Kruskal-Wallis 合适
3. **趋势筛选**: Spearman 相关用于筛选单调趋势菌门，但后续检验针对组间差异 (非线性趋势检验)
